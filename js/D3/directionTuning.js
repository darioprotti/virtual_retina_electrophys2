var maxTime=1e3,spontaneousRate=7,currRadians=0,currAngle=0,currContrast=100,radius=200,angleScale,firingScale,directions=[0,30,60,90,120,150,180,210,240,270,300,330],contrast=[0,20,40,60,80,100],colors=["#ffffcc","#c7e9b4","#7fcdbb","#41b6c4","#2c7fb8","#253494"],nowBuffering,available_indexes=[-1,0],randomSeed,adaptationExp=1.5,mysteryGain=1.1,DSTabOn=[""],prefDirectionAng,prefDirectionRad,kappa,amplitude,offset,maxRate;makeStimScreen("div#stimulusMonitor"),visualSpikes=new SpikeVisualization({width:450,height:150},maxTime),visualSpikes.makeOscilloscope("div.oscilloscope"),$("#DSTab").on("click",function(){d3.select("#grating").attr("xlink:href","img/visual/grating100_orig.png").attr({x:-680,y:-240}),DSTabOn="ON",ChrSTabOn="",kappa="CellA"===choice?0:"CellB"===choice?0:kappa}),$(document).ready(function(){browserSupportsAudio&&(audioObj=new AudioSpikes(maxTime,1)),$("#contrast").on("change",function(){currContrast=10*Number($("#contrast").val()),d3.select("#grating").attr("xlink:href","img/visual/grating"+currContrast+".png")}),$("#startStim").on("click",function(){if(1===$(".spikeData").length){if(!$(".spikeData").attr("finished"))return;$(".spikeData").remove()}$("#knobDiv").append('<div id="knobCover" style="position:relative;width:144px;height:144px;top:-120px;"></div>');var a=5+poisson(currContrast/100*amplitude*vonMises(2*Math.PI-currRadians,prefDirectionRad,kappa)+offset);0===currContrast?currAdaptationExp=1:currAdaptationExp=adaptationExp;var e=visualSpikes.generateSpikeTimes(a,[10,maxTime-5],currAdaptationExp);visualSpikes.generateSpikeTrace(e),visualSpikes.addTraceToOscilloscope().each("end",function(){d3.select(".spikeData").attr("finished",!0),d3.select("#grating").transition().duration(1).ease("easeInExpo").attr({x:-680,y:-240}),d3.select(".userData1").append("circle").attr("class","data"+contrast.indexOf(currContrast)).attr("cx",tunCurve.angleScale((360-currAngle)%360)).attr("cy",tunCurve.firingScale(a)).attr("r",4).attr("fill",colors[currContrast/20]).attr("fill-opacity",.4).attr("stroke","darkgrey"),d3.select("#knobCover").remove()}),browserSupportsAudio&&(audioObj.addWhiteNoise(),audioObj.addSpikesToAudio(e),audioObj.playBuffer()),d3.select("#grating").transition().duration(1e3).ease("easeInExpo").attr({x:-240,y:-240})}),$("#downloadData").on("click",function(){downloadVisualData(maxTime)}),$("#clearData1").on("click",function(){$('<div title="Are you sure?">This will clear all of the data points that you have collected so far from the bottom right panel. </div>').dialog({modal:!0,buttons:{Confirm:function(){clearData1(maxRate,labels),$(this).dialog("destroy").remove()},Cancel:function(){$(this).dialog("destroy").remove()}},closeOnEscape:!1,open:function(){$(".ui-dialog-titlebar-close").hide()}})})});